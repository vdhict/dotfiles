#!/usr/bin/env bash
# {{ template "scripts-library" }}

# Skip in minimum mode or devcontainer
{{ if or .is_minimum .is_devcontainer }}
exit 0
{{ end }}

true || source ../.chezmoitemplates/scripts-library

# Check if 1Password CLI is already installed
if command -v op &>/dev/null; then
  log_info "1Password CLI already installed"
  exit 0
fi

log_task "Installing 1Password CLI..."

{{ if .is_macos }}
# macOS: Install via Homebrew
if command -v brew &>/dev/null; then
  c brew install --cask 1password-cli
else
  log_error "Homebrew not found. Please install 1Password CLI manually."
  exit 1
fi
{{ else }}
# Linux: Install manually
OP_VERSION="2.30.3"
OP_ARCH="amd64"

if [[ "$(uname -m)" == "aarch64" ]]; then
  OP_ARCH="arm64"
fi

TEMP_DIR=$(mktemp -d)
cd "${TEMP_DIR}"

log_info "Downloading 1Password CLI v${OP_VERSION}..."
curl -sSfLO "https://cache.agilebits.com/dist/1P/op2/pkg/v${OP_VERSION}/op_linux_${OP_ARCH}_v${OP_VERSION}.zip"

unzip -q "op_linux_${OP_ARCH}_v${OP_VERSION}.zip"
sudo mv op /usr/local/bin/
sudo chmod +x /usr/local/bin/op

# Set up group for CLI
sudo groupadd -f onepassword-cli
sudo chgrp onepassword-cli /usr/local/bin/op
sudo chmod g+s /usr/local/bin/op

cd -
rm -rf "${TEMP_DIR}"
{{ end }}

log_success "1Password CLI installed"
log_manual_action "Please open 1Password app and enable CLI integration:"
log_manual_action "  Settings > Developer > Integrate with 1Password CLI"
